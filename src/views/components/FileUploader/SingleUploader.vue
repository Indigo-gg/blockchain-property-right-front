<template>
  <div>
    <a-upload
      v-decorator="['videoUrl',{valuePropName: 'fileList',getValueFromEvent: normFile,rules: [{required: true, message: '请上传商品视频！'}]},]"
      name="file"
      :accept="'video/mp4'"
      list-type="picture-card"
      @change="videoUploadChange"
      :before-upload="videoBeforeUpload"
      :preview-file="videoPreview"
    >

      <div >
        <a-icon type="plus" />
        <div class="ant-upload-text">
          Upload
        </div>
      </div>
      <a-modal :visible="videoPreviewVisible" :footer="null" @cancel="videoPreviewCancel" >
        <video width="100%" height="600px;" controls="controls" id="video">
          您的浏览器不支持播放该视频！
        </video>
      </a-modal>
    </a-upload>
  </div>
</template>

<script>
// import { getAuthorization } from '@/utils/cookieUtil'
import { UploadFile } from '@/api/modules/file'

export default {
  watch: {
    // 预览并播放视频时,如果关闭了弹框,电脑还有视频的声音,监听视频预览的弹框的打开/关闭,如果关闭了弹框就让video不要播放了
    videoPreviewVisible: function (val) {
      if (val === false) {
        const video = document.getElementById('video')
        video.pause()
      }
    }
  },
  data () {
    return {
      uploadHeaders: {
        'access_token': this.$store.getters.token
      },		// 这里是从cookie中取token值,后台鉴权用的
      action: 'http://60.205.225.137:8087/file/upload',
      videoPreviewVisible: false,
      singleFile: {}
    }
  },
  methods: {
   async handleUpload (file) {
      const fileData = new FormData()
      fileData.append('file', file.file)
      const type = this.praseFileType(file.file.type)
      if (type < 0) {
        this.$message.error('上传文件类型转换错误')
      }
      fileData.append('type', type)
      fileData.append('source', 1)
      UploadFile(fileData).then(res => {
        // console.log('接口返回结果', res.data)
        file.onSuccess(res, file)
      }).catch(err => {
        console.log('fileUploadErr', err)

        // 文件上传失败
        this.$emit('uploadErr', err)
        file.onError(err, file)
      })
    },
    praseFileType (rawType) {
      // 判断传给服务端的文件类型参数
      let code = -1
      const types = [
        { pattern: 'text', code: 1 },
        { pattern: 'image', code: 2 },
        { pattern: 'audio', code: 3 },
        { pattern: 'video', code: 4 },
        { pattern: 'application', code: 5 }
      ]
      for (let i = 0; i < types.length; i++) {
        if (rawType.indexOf(types[i].pattern) >= 0) {
          code = types[i].code
          break
        }
      }
      return code
    },
    normFile (e) {
      // 本方法作用,因为我的业务是只能上传一个视频,因此每次上传时只保留uoload组件的fileList字段的最后一个值作为提交给后台的数据
      if (Array.isArray(e)) {
        return e
      }
      if (e && e.fileList) {
        // 截取最后一个元素,返回只包含最后一个元素的数组
        let fileList = e.fileList.slice(-1)
        fileList = fileList.map(file => {
          if (file.response) {
            // Component will show file.url as link
            file.url = file.response.data	// file.response.data是后台返回的当前视频上传成功后入库的url
          }
          return file
        })
        e.fileList = fileList
      }
      return e && e.fileList
    },
    videoUploadChange ({ file, fileList }) {
      if (file.status === 'error') {
        fileList.pop()
        this.$message.error('上传失败!')
      }

      if (file.status === 'done') {
        this.$message.info('文件上传成功！')
        console.log(file)
        this.singleFile.file = this.parseFile(file)
        this.singleFile.loaded = true
        this.$emit('uploadSingleFileSuccess', this.singleFile.file)
      }
    },
    parseFile (file) {
      let fileData = {}
      if (file.response) {
        fileData.name = file.name
        fileData.uid = file.uid
        fileData.fileId = file.response.data.fileId
        fileData.status = file.status
      } else {
        fileData = file
      }
      return fileData
    },
    videoBeforeUpload (file) {
      const isLt10M = file.size / 1024 / 1024 < 10
      if (!isLt10M) {
        this.$message.error('视频大小不能超过10M!')
      }
      return isLt10M
    },
    videoPreview (file) {
      // 预览视频的方法

      this.handleUpload(file)
      console.log('我要预览文件！！！', file)
      this.videoPreviewVisible = true
      this.$nextTick(() => {	// 这里一定要使用nextTick,否则document将找不到id为video的节点,因为modal框初始为隐藏状态,<video id='video'>标签初始在dom树中并不存在
        const video = document.getElementById('video')
        video.src = file.url
      })
    },
    videoPreviewCancel () {
      this.videoPreviewVisible = false
    }

  }
}
</script>
00000000































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































